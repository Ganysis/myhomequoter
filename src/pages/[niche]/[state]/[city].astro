---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { niches, getNicheBySlug, getAllNicheSlugs } from '../../../lib/niches';
import { usStates, getStateName, topCitiesByState } from '../../../lib/states';
import { getSolarIncentives, getAvgCost, getClimateData, getCityData } from '../../../lib/local-data';

// Generate static paths for all niche/state/city combinations
export function getStaticPaths() {
  const paths: { params: { niche: string; state: string; city: string } }[] = [];

  // For initial build, generate paths for top cities in major states
  const nicheSlugs = getAllNicheSlugs();

  for (const nicheSlug of nicheSlugs) {
    for (const [stateCode, cities] of Object.entries(topCitiesByState)) {
      for (const city of cities) {
        paths.push({
          params: {
            niche: nicheSlug,
            state: stateCode.toLowerCase(),
            city: city.toLowerCase().replace(/\s+/g, '-'),
          },
        });
      }
    }
  }

  return paths;
}

const { niche: nicheSlug, state: stateCode, city: citySlug } = Astro.params;
const niche = getNicheBySlug(nicheSlug);

if (!niche) {
  return Astro.redirect('/404');
}

// Convert slugs back to display names
const stateName = getStateName(stateCode.toUpperCase());
const cityName = citySlug
  .split('-')
  .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ');

const stateUpper = stateCode.toUpperCase();

// Related cities in same state
const relatedCities = (topCitiesByState[stateUpper] || [])
  .filter((c) => c.toLowerCase().replace(/\s+/g, '-') !== citySlug)
  .slice(0, 6);

// Get local data for unique content
const localCost = getAvgCost(nicheSlug, stateUpper);
const climate = getClimateData(stateUpper);
const cityInfo = getCityData(cityName, stateUpper);
const solarIncentives = nicheSlug === 'solar' ? getSolarIncentives(stateUpper) : null;

// Build unique intro based on niche and local data
const buildIntro = () => {
  let intro = `Looking for reliable ${niche.name.toLowerCase()} services in ${cityName}, ${stateName}? `;

  if (cityInfo) {
    intro += `As one of the largest cities in ${stateName} with a metro population of ${cityInfo.metro}, ${cityName} has a strong network of licensed contractors. `;
  }

  if (nicheSlug === 'solar' && solarIncentives) {
    intro += `${stateName} offers ${solarIncentives.netMetering ? 'net metering, allowing you to sell excess power back to the grid' : 'various solar incentives'}. `;
    if (solarIncentives.rebates !== 'Limited') {
      intro += `Local rebates include: ${solarIncentives.rebates}. `;
    }
  } else if (climate && climate.considerations.length > 0) {
    intro += `${climate.considerations[0]}. `;
  }

  intro += `Get up to 4 free quotes from pre-screened, licensed contractors serving ${cityName}.`;
  return intro;
};

const pageContent = {
  heroTitle: `${niche.name} in ${cityName}, ${stateUpper}`,
  heroSubtitle: cityInfo?.nickname
    ? `Trusted ${niche.name} Contractors in "${cityInfo.nickname}"`
    : `Get Free Quotes from Top-Rated ${niche.name} Contractors`,
  intro: buildIntro(),
  localStats: {
    avgCost: localCost,
    contractors: cityInfo ? '25+' : '15+',
    responseTime: 'Same day',
  },
};

// Build unique FAQs based on niche and location
const faqs = [
  {
    question: `How much does ${niche.name.toLowerCase()} cost in ${cityName}, ${stateUpper}?`,
    answer: `The average cost for ${niche.name.toLowerCase()} in ${cityName} ranges from ${localCost}. ${climate?.type ? `Given ${stateName}'s ${climate.type.toLowerCase()} climate, ` : ''}prices can vary based on project scope, materials, and specific requirements. Request free quotes for an accurate estimate for your project.`,
  },
  {
    question: `How do I find the best ${niche.name.toLowerCase()} contractor in ${cityName}?`,
    answer: `We connect ${cityName} homeowners with pre-screened, licensed contractors. All professionals in our network are verified, insured, and have positive customer reviews. Submit your project details to receive up to 4 competitive quotes from local ${cityName} pros.`,
  },
  ...(nicheSlug === 'solar' && solarIncentives ? [{
    question: `What solar incentives are available in ${stateName}?`,
    answer: `${stateName} homeowners can benefit from: ${solarIncentives.stateTaxCredit}. ${solarIncentives.netMetering ? 'Net metering is available, allowing you to earn credits for excess energy production.' : ''} ${solarIncentives.rebates !== 'Limited' ? `Additional rebates: ${solarIncentives.rebates}.` : ''} Average annual savings in ${stateName}: ${solarIncentives.avgSavings}.`,
  }] : []),
  {
    question: `What should I consider for ${niche.name.toLowerCase()} in ${cityName}'s climate?`,
    answer: climate
      ? `${cityName} has a ${climate.type.toLowerCase()} climate. Key considerations: ${climate.considerations.join('. ')}. Local contractors understand these factors and can recommend appropriate materials and solutions.`
      : `Local ${cityName} contractors understand regional weather patterns and can recommend appropriate materials and approaches for your project.`,
  },
  {
    question: `Do I need a permit for ${niche.name.toLowerCase()} in ${cityName}, ${stateUpper}?`,
    answer: `Permit requirements in ${cityName} vary by project type and scope. Most ${niche.name.toLowerCase()} projects require permits for safety compliance. Your contractor will advise on specific ${cityName} permit needs and typically handle the application process.`,
  },
];
---

<BaseLayout
  title={`${niche.name} in ${cityName}, ${stateUpper} | Free Quotes`}
  description={`Get free ${niche.name.toLowerCase()} quotes in ${cityName}, ${stateName}. Compare prices from ${pageContent.localStats.contractors} licensed contractors. Same-day response.`}
>
  <!-- Hero Section -->
  <section class="relative bg-gradient-to-br from-gray-900 to-gray-800 text-white overflow-hidden">
    <div class="absolute inset-0 opacity-20" style={`background-color: ${niche.color};`}></div>
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 lg:py-20">
      <nav class="flex items-center space-x-2 text-sm text-gray-400 mb-6">
        <a href="/" class="hover:text-white">Home</a>
        <span>/</span>
        <a href={`/${niche.slug}/`} class="hover:text-white">{niche.name}</a>
        <span>/</span>
        <a href={`/${niche.slug}/${stateCode}/`} class="hover:text-white">{stateName}</a>
        <span>/</span>
        <span class="text-white">{cityName}</span>
      </nav>

      <div class="grid lg:grid-cols-2 gap-12 items-start">
        <div>
          <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white/10 backdrop-blur mb-4">
            <span class="w-2 h-2 rounded-full mr-2" style={`background-color: ${niche.color};`}></span>
            {cityName}, {stateUpper}
          </div>
          <h1 class="text-4xl sm:text-5xl font-bold leading-tight">
            {pageContent.heroTitle}
          </h1>
          <p class="mt-4 text-xl text-gray-300">
            {pageContent.heroSubtitle}
          </p>
          <p class="mt-6 text-gray-300">
            {pageContent.intro}
          </p>

          <!-- Local Stats -->
          <div class="mt-8 grid grid-cols-3 gap-4">
            <div class="bg-white/10 backdrop-blur rounded-lg p-4 text-center">
              <div class="text-2xl font-bold">{pageContent.localStats.contractors}</div>
              <div class="text-sm text-gray-400">Local Pros</div>
            </div>
            <div class="bg-white/10 backdrop-blur rounded-lg p-4 text-center">
              <div class="text-2xl font-bold">{pageContent.localStats.responseTime}</div>
              <div class="text-sm text-gray-400">Response</div>
            </div>
            <div class="bg-white/10 backdrop-blur rounded-lg p-4 text-center">
              <div class="text-2xl font-bold">Free</div>
              <div class="text-sm text-gray-400">Quotes</div>
            </div>
          </div>
        </div>

        <!-- Quick Form -->
        <div class="bg-white rounded-2xl shadow-2xl p-6 lg:p-8">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Get Free Quotes</h2>
          <p class="text-gray-600 mb-6">Compare prices from {cityName} contractors</p>

          <form action={`/get-quotes/?service=${niche.slug}`} method="get" class="space-y-4">
            <input type="hidden" name="service" value={niche.slug} />
            <input type="hidden" name="city" value={cityName} />
            <input type="hidden" name="state" value={stateUpper} />

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Project Type</label>
              <select
                name="project_type"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
              >
                <option value="installation">New Installation</option>
                <option value="repair">Repair / Fix</option>
                <option value="replacement">Replacement</option>
                <option value="consultation">Consultation</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code</label>
              <input
                type="text"
                name="zip"
                placeholder="Enter your ZIP code"
                maxlength="5"
                pattern="[0-9]{5}"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                required
              />
            </div>

            <button
              type="submit"
              class="w-full px-6 py-4 text-white font-semibold rounded-lg transition-colors"
              style={`background-color: ${niche.color};`}
            >
              Get Free Quotes
            </button>

            <p class="text-xs text-center text-gray-500">
              Free, no obligation. Takes 2 minutes.
            </p>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Why Choose Section -->
  <section class="py-16 lg:py-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-3xl font-bold text-gray-900 text-center mb-12">
        Why Choose {cityName} {niche.name} Pros?
      </h2>

      <div class="grid md:grid-cols-3 gap-8">
        <div class="text-center p-6">
          <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4" style={`background-color: ${niche.color}20;`}>
            <svg class="w-8 h-8" style={`color: ${niche.color};`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 mb-2">Local Expertise</h3>
          <p class="text-gray-600">
            Our contractors know {cityName} building codes, weather conditions, and local requirements.
          </p>
        </div>

        <div class="text-center p-6">
          <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4" style={`background-color: ${niche.color}20;`}>
            <svg class="w-8 h-8" style={`color: ${niche.color};`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 mb-2">Verified & Insured</h3>
          <p class="text-gray-600">
            Every contractor is licensed, insured, and background-checked for your protection.
          </p>
        </div>

        <div class="text-center p-6">
          <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4" style={`background-color: ${niche.color}20;`}>
            <svg class="w-8 h-8" style={`color: ${niche.color};`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <h3 class="text-xl font-semibold text-gray-900 mb-2">Competitive Pricing</h3>
          <p class="text-gray-600">
            Get up to 4 quotes from {cityName} contractors and choose the best value.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ Section -->
  <section class="py-16 lg:py-20 bg-gray-50">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-3xl font-bold text-gray-900 text-center mb-12">
        {niche.name} FAQ for {cityName}, {stateUpper}
      </h2>

      <div class="space-y-4">
        {faqs.map((faq) => (
          <details class="group bg-white rounded-lg border border-gray-200 overflow-hidden">
            <summary class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-50">
              <span class="font-medium text-gray-900 pr-4">{faq.question}</span>
              <svg class="w-5 h-5 text-gray-500 group-open:rotate-180 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="p-4 pt-0 text-gray-600">
              {faq.answer}
            </div>
          </details>
        ))}
      </div>
    </div>
  </section>

  <!-- Other Cities -->
  {relatedCities.length > 0 && (
    <section class="py-16 lg:py-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-900 text-center mb-8">
          {niche.name} in Other {stateName} Cities
        </h2>

        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {relatedCities.map((relatedCity) => (
            <a
              href={`/${niche.slug}/${stateCode}/${relatedCity.toLowerCase().replace(/\s+/g, '-')}/`}
              class="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-md transition-shadow flex items-center justify-between"
            >
              <div>
                <div class="font-medium text-gray-900">{relatedCity}</div>
                <div class="text-sm text-gray-500">{niche.name}</div>
              </div>
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA Section -->
  <section class="py-16" style={`background-color: ${niche.color};`}>
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="text-3xl lg:text-4xl font-bold text-white">
        Ready for Your {niche.name} Project in {cityName}?
      </h2>
      <p class="mt-4 text-xl text-white/90">
        Get free quotes from licensed {cityName} contractors today
      </p>
      <a
        href={`/get-quotes/?service=${niche.slug}`}
        class="mt-8 inline-flex items-center px-8 py-4 bg-white font-semibold rounded-lg hover:bg-gray-100 transition-colors"
        style={`color: ${niche.color};`}
      >
        Get Free Quotes Now
        <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </div>
  </section>

  <!-- Schema Markup -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "name": `${niche.name} Services in ${cityName}, ${stateUpper}`,
    "description": `Find trusted ${niche.name.toLowerCase()} contractors in ${cityName}, ${stateName}`,
    "areaServed": {
      "@type": "City",
      "name": cityName,
      "containedInPlace": {
        "@type": "State",
        "name": stateName
      }
    },
    "serviceType": niche.name
  })} />

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": faqs.map((faq) => ({
      "@type": "Question",
      "name": faq.question,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": faq.answer
      }
    }))
  })} />

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://myhomequoter.com/" },
      { "@type": "ListItem", "position": 2, "name": niche.name, "item": `https://myhomequoter.com/${niche.slug}/` },
      { "@type": "ListItem", "position": 3, "name": stateName, "item": `https://myhomequoter.com/${niche.slug}/${stateCode}/` },
      { "@type": "ListItem", "position": 4, "name": cityName }
    ]
  })} />
</BaseLayout>
