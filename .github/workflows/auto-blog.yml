# ğŸš€ AUTOMATED BLOG GENERATION - MyHomeQuoter
#
# FULLY AUTONOMOUS SYSTEM:
# - Runs 3x/day automatically
# - 5 articles per run = 15 articles/day
# - Quality gate: 80/100 minimum
# - Auto-deploy to Cloudflare
#
# Schedule (UTC):
# - 08:00 â†’ 5 articles (2 Solar, 2 Roofing, 1 HVAC)
# - 14:00 â†’ 5 articles
# - 20:00 â†’ 5 articles + Deploy

name: Auto Blog Generation

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      count:
        description: 'Articles to generate'
        required: false
        default: '5'
        type: choice
        options:
          - '1'
          - '3'
          - '5'
          - '10'
      category:
        description: 'Category focus'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'solar'
          - 'roofing'
          - 'hvac'
      silo:
        description: 'Silo type'
        required: false
        default: 'auto'
        type: choice
        options:
          - 'auto'
          - 'pillar'
          - 'cluster'
          - 'supporting'

  # Scheduled - 3x daily for 15 articles/day
  schedule:
    - cron: '0 8 * * *'   # 08:00 UTC
    - cron: '0 14 * * *'  # 14:00 UTC
    - cron: '0 20 * * *'  # 20:00 UTC

permissions:
  contents: write

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure parameters
        id: config
        run: |
          # Get parameters (defaults for scheduled runs)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "count=${{ github.event.inputs.count || '5' }}" >> $GITHUB_OUTPUT
            echo "category=${{ github.event.inputs.category || 'all' }}" >> $GITHUB_OUTPUT
            echo "silo=${{ github.event.inputs.silo || 'auto' }}" >> $GITHUB_OUTPUT
          else
            # Scheduled run defaults
            echo "count=5" >> $GITHUB_OUTPUT
            echo "category=all" >> $GITHUB_OUTPUT
            echo "silo=auto" >> $GITHUB_OUTPUT
          fi

      - name: Generate blog articles
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ğŸš€ Starting blog generation..."
          echo "   Count: ${{ steps.config.outputs.count }}"
          echo "   Category: ${{ steps.config.outputs.category }}"
          echo "   Silo: ${{ steps.config.outputs.silo }}"

          # Build command
          CMD="npx tsx scripts/auto-generate-blog.ts --count ${{ steps.config.outputs.count }}"

          if [ "${{ steps.config.outputs.category }}" != "all" ]; then
            CMD="$CMD --category ${{ steps.config.outputs.category }}"
          fi

          if [ "${{ steps.config.outputs.silo }}" != "auto" ]; then
            CMD="$CMD --silo ${{ steps.config.outputs.silo }}"
          fi

          echo "ğŸ“ Running: $CMD"
          eval $CMD

      - name: Build site
        run: npm run build

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ New articles generated:"
            git diff --staged --name-only | grep "src/content/blog" || true
          fi

      - name: Commit articles
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          COUNT=$(git diff --staged --name-only | grep "src/content/blog" | wc -l || echo "0")

          git commit -m "ğŸ“ Auto-generated $COUNT blog articles

          Date: $(date -u +"%Y-%m-%d %H:%M UTC")
          Category: ${{ steps.config.outputs.category }}
          Trigger: ${{ github.event_name }}

          ğŸ¤– Generated with Claude AI
          Co-Authored-By: Claude <noreply@anthropic.com>"

          git push

      - name: Deploy to Cloudflare
        if: steps.changes.outputs.has_changes == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            echo "ğŸš€ Deploying to Cloudflare Pages..."
            npx wrangler pages deploy dist --project-name=myhomequoter
          else
            echo "âš ï¸ Cloudflare credentials not configured, skipping deploy"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ğŸ“Š Blog Generation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Date | $(date -u +'%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Articles Requested | ${{ steps.config.outputs.count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Category | ${{ steps.config.outputs.category }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changes | ${{ steps.changes.outputs.has_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          ls -la src/content/blog/*.md 2>/dev/null | tail -5 >> $GITHUB_STEP_SUMMARY || echo "No files" >> $GITHUB_STEP_SUMMARY
